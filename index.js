
const TelegramBot = require('node-telegram-bot-api');
const ExcelJS = require('exceljs'); // Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…ÙƒØªØ¨Ø© exceljs
require('dotenv').config(); // Ø¥Ø°Ø§ ÙƒÙ†Øª ØªØ³ØªØ®Ø¯Ù… Ù…ØªØºÙŠØ±Ø§Øª Ø¨ÙŠØ¦ÙŠØ©
const express = require('express'); // Ø¥Ø¶Ø§ÙØ© Express Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙŠØ±ÙØ±

// Ø¥Ø¹Ø¯Ø§Ø¯ Ø³ÙŠØ±ÙØ± Express (Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù„Ù‰ Render Ø£Ùˆ ÙÙŠ Ø¨ÙŠØ¦Ø© Ù…Ø­Ù„ÙŠØ©)
const app = express();
const port = process.env.PORT || 4000; // Ø§Ù„Ù…Ù†ÙØ° Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
app.get('/', (req, res) => {
    res.send('The server is running successfully.');
});

// Ø§Ø³ØªØ¨Ø¯Ù„ Ø¨Ø§Ù„ØªÙˆÙƒÙ† Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
const token = process.env.TELEGRAM_BOT_TOKEN || 'AAEaT5eaKIKYnbD7jtlEijifCr7z7t1ZBL0';

// Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¹Ø±ÙØ§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ†
const adminIds = process.env.ADMIN_IDS?.split(',') || ['7719756994', 'ADMIN_ID_2']; // Ø¶Ø¹ Ù…Ø¹Ø±ÙØ§Øª Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ† Ù‡Ù†Ø§

// Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¨ÙˆØª
const bot = new TelegramBot(token, { polling: true });

// ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Excel
let data = [];

// Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ
let isBroadcastMode = false;

// Ø¯Ø§Ù„Ø© Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Excel
async function loadDataFromExcel() {
    try {
        const workbook = new ExcelJS.Workbook();
        await workbook.xlsx.readFile('gas18-11-2024.xlsx'); // Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù
        const worksheet = workbook.worksheets[0]; // Ø£ÙˆÙ„ ÙˆØ±Ù‚Ø© Ø¹Ù…Ù„

        worksheet.eachRow((row, rowNumber) => {
            const idNumber = row.getCell(1).value?.toString().trim(); // Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©
            const name = row.getCell(2).value?.toString().trim(); // Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ§Ø·Ù†
            const province = row.getCell(3).value?.toString().trim(); // Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©
            const district = row.getCell(4).value?.toString().trim(); // Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©
            const area = row.getCell(5).value?.toString().trim(); // Ø§Ù„Ø­ÙŠ/Ø§Ù„Ù…Ù†Ø·Ù‚Ø©
            const distributorId = row.getCell(6).value?.toString().trim(); // Ù‡ÙˆÙŠØ© Ø§Ù„Ù…ÙˆØ²Ø¹
            const distributorName = row.getCell(7).value?.toString().trim(); // Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ²Ø¹
            const distributorPhone = row.getCell(8).value?.toString().trim(); // Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø§Ù„Ù…ÙˆØ²Ø¹
            const status = row.getCell(9).value?.toString().trim(); // Ø§Ù„Ø­Ø§Ù„Ø©
            const orderDate = row.getCell(12).value?.toString().trim(); // ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨

            if (idNumber && name) {
                data.push({
                    idNumber,
                    name,
                    province: province || "ØºÙŠØ± Ù…ØªÙˆÙØ±",
                    district: district || "ØºÙŠØ± Ù…ØªÙˆÙØ±",
                    area: area || "ØºÙŠØ± Ù…ØªÙˆÙØ±",
                    distributorId: distributorId || "ØºÙŠØ± Ù…ØªÙˆÙØ±",
                    distributorName: distributorName || "ØºÙŠØ± Ù…ØªÙˆÙØ±",
                    distributorPhone: distributorPhone || "ØºÙŠØ± Ù…ØªÙˆÙØ±",
                    status: status || "ØºÙŠØ± Ù…ØªÙˆÙØ±",
                    orderDate: orderDate || "ØºÙŠØ± Ù…ØªÙˆÙØ±",
                });
            }
        });

        console.log('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­.');
    } catch (error) {
        console.error('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù Excel:', error.message);
    }
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
loadDataFromExcel();

// Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø¨ÙˆØª
bot.onText(/\/start/, (msg) => {
    const chatId = msg.chat.id;
    const isAdmin = adminIds.includes(chatId.toString());

    const keyboard = [
        [{ text: "ðŸ” Ø§Ù„Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ© Ø£Ùˆ Ø§Ù„Ø§Ø³Ù…" }],
        [{ text: "ðŸ“ž Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„" }, { text: "ðŸ“– Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ù† Ø§Ù„Ø¨ÙˆØª" }],
    ];

    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¤ÙˆÙ„Ù‹Ø§ØŒ Ø£Ø¶Ù Ø²Ø± "Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø¬Ù…ÙŠØ¹"
    if (isAdmin) {
        keyboard.push([{ text: "ðŸ“¢ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹" }]);
    }

    const options = {
        reply_markup: {
            keyboard,
            resize_keyboard: true, // Ø¶Ø¨Ø· Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù„ØªØªÙ†Ø§Ø³Ø¨ Ù…Ø¹ Ø§Ù„Ø­Ø¬Ù…
            one_time_keyboard: false, // ØªØ¬Ø¹Ù„ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù…Ø±Ø¦ÙŠØ© Ø¯Ø§Ø¦Ù…Ù‹Ø§
        },
    };

    bot.sendMessage(chatId, "Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ! Ø§Ø®ØªØ± Ø£Ø­Ø¯ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©:", options);
});

// Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙˆØ§Ù„Ø±Ø³Ø§Ø¦Ù„
bot.on('message', async (msg) => {
    const chatId = msg.chat.id;
    const input = msg.text.trim();
    const isAdmin = adminIds.includes(chatId.toString());

    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ·Ù„Ø¨ "Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹"
    if (input === "ðŸ“¢ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹") {
        if (isAdmin) {
            isBroadcastMode = true; // ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ
            bot.sendMessage(chatId, "âœ‰ï¸ Ø§ÙƒØªØ¨ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:");
        } else {
            bot.sendMessage(chatId, "âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø®ÙŠØ§Ø± Ù…ØªØ§Ø­ ÙÙ‚Ø· Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ†.");
        }
        return;
    }

    // Ø¥Ø°Ø§ ÙƒØ§Ù† ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ
    if (isBroadcastMode) {
        if (isAdmin) {
            const broadcastMessage = input; // Ø­ÙØ¸ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø©
            isBroadcastMode = false; // Ø¥Ù„ØºØ§Ø¡ ÙˆØ¶Ø¹ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ Ø¨Ø¹Ø¯ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø±Ø³Ø§Ù„Ø©
            await sendMessageToAllUsers(broadcastMessage);
            bot.sendMessage(chatId, "âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹.");
        }
        return;
    }

    // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ
    if (input === "ðŸ” Ø§Ù„Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ© Ø£Ùˆ Ø§Ù„Ø§Ø³Ù…") {
        bot.sendMessage(chatId, "ðŸ“ Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ© Ø£Ùˆ Ø§Ù„Ø§Ø³Ù… Ù„Ù„Ø¨Ø­Ø«:");
    } else if (input === "ðŸ“ž Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„") {
        const contactMessage = `
ðŸ“ž **Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„:**
Ù„Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ø¯Ø¹Ù… Ø£Ùˆ Ø§Ù„Ø§Ø³ØªÙØ³Ø§Ø±ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§ Ø¹Ø¨Ø±:

- ðŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ: [mrahel1991@gmail.com]
- ðŸ“± Ø¬ÙˆØ§Ù„ : [0598550144]
- ðŸ’¬ ØªÙ„ØºØ±Ø§Ù… : [https://t.me/AhmedGarqoud]
        `;
        bot.sendMessage(chatId, contactMessage, { parse_mode: 'Markdown' });
    } else if (input === "ðŸ“– Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ù† Ø§Ù„Ø¨ÙˆØª") {
        const aboutMessage = `
ðŸ¤– **Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ù† Ø§Ù„Ø¨ÙˆØª:**
Ù‡Ø°Ø§ Ø§Ù„Ø¨ÙˆØª ÙŠØªÙŠØ­ Ù„Ùƒ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…ÙˆØ§Ø·Ù†ÙŠÙ† Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ© Ø£Ùˆ Ø§Ù„Ø§Ø³Ù….

- ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ© Ø£Ùˆ Ø§Ù„Ø§Ø³Ù….
- ÙŠØªÙ… Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø·Ù† Ø¨Ù…Ø§ ÙÙŠ Ø°Ù„Ùƒ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ²Ø¹ ÙˆØ­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨.

ðŸ”§ **Ø§Ù„ØªØ·ÙˆÙŠØ± ÙˆØ§Ù„ØµÙŠØ§Ù†Ø©**: ØªÙ… ØªØ·ÙˆÙŠØ± Ù‡Ø°Ø§ Ø§Ù„Ø¨ÙˆØª Ø¨ÙˆØ§Ø³Ø·Ø© [Ø§Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯ Ø§Ø¨Ùˆ ØºØ±Ù‚ÙˆØ¯].
        `;
        bot.sendMessage(chatId, aboutMessage, { parse_mode: 'Markdown' });
    } else {
        const user = data.find((entry) => entry.idNumber === input || entry.name === input);

        if (user) {
            const response = `
ðŸ” **ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨:**

ðŸ‘¤ **Ø§Ù„Ø§Ø³Ù…**: ${user.name}
ðŸ“ **Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©**: ${user.province}
ðŸ™ï¸ **Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©**: ${user.district}
ðŸ˜ï¸ **Ø§Ù„Ø­ÙŠ / Ø§Ù„Ù…Ù†Ø·Ù‚Ø©**: ${user.area}

ðŸ†” **Ù‡ÙˆÙŠØ© Ø§Ù„Ù…ÙˆØ²Ø¹**: ${user.distributorId}  
ðŸ“› **Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ²Ø¹**: ${user.distributorName}
ðŸ“ž **Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø§Ù„Ù…ÙˆØ²Ø¹**: ${user.distributorPhone}

ðŸ“œ **Ø§Ù„Ø­Ø§Ù„Ø©**: ${user.status}
ðŸ“… **ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨**: ${user.orderDate}
            `;
            bot.sendMessage(chatId, response, { parse_mode: 'Markdown' });
        } else {
            bot.sendMessage(chatId, "âš ï¸ Ù„Ù… Ø£ØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù…Ø¯Ø®Ù„ Ø§Ù„Ù…Ù‚Ø¯Ù….");
        }
    }
});

// Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø¬Ù…Ø§Ø¹ÙŠØ©
async function sendMessageToAllUsers(message) {
    try {
        const updates = await bot.getUpdates();
        const uniqueChatIds = [...new Set(updates.map(update => update.message?.chat.id).filter(Boolean))];

        for (const chatId of uniqueChatIds) {
            await bot.sendMessage(chatId, message);
        }
        console.log("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹.");
    } catch (error) {
        console.error("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„:", error.message);
    }
}

// ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙŠØ±ÙØ±
app.listen(port, () => {
    console.log(`Server is running on port ${port}`);
});
