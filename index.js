const TelegramBot = require('node-telegram-bot-api');
const ExcelJS = require('exceljs'); // Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…ÙƒØªØ¨Ø© exceljs
require('dotenv').config(); // Ø¥Ø°Ø§ ÙƒÙ†Øª ØªØ³ØªØ®Ø¯Ù… Ù…ØªØºÙŠØ±Ø§Øª Ø¨ÙŠØ¦ÙŠØ©
const express = require('express'); // Ø¥Ø¶Ø§ÙØ© Express Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙŠØ±ÙØ±
const axios = require('axios'); // Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… API Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù‚Ø³ ÙˆØ§Ù„Ø¹Ù…Ù„Ø§Øª

// Ø¥Ø¹Ø¯Ø§Ø¯ Ø³ÙŠØ±ÙØ± Express
const app = express();
const port = process.env.PORT || 4000;
app.get('/', (req, res) => {
    res.send('The server is running successfully.');
});

// Ø§Ø³ØªØ¨Ø¯Ù„ Ø¨Ø§Ù„ØªÙˆÙƒÙ† Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
const token = process.env.TELEGRAM_BOT_TOKEN || '7201507244:AAFmUzJTZ0CuhWxTE_BjwQJ-XB3RXlYMKYU';

// Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¨ÙˆØª
const bot = new TelegramBot(token, { polling: true });

// ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Excel
let data = [];

// Ù‚Ø§Ø¦Ù…Ø© Ù…Ø¹Ø±ÙØ§Øª Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ†
const adminIds = process.env.ADMIN_IDS?.split(',') || ['7719756994']; // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„

// Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø¨ÙˆØª
bot.onText(/\/start/, (msg) => {
    const chatId = msg.chat.id;
    const options = {
        reply_markup: {
            keyboard: [
                [{ text: "ðŸ” Ø§Ù„Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ© Ø£Ùˆ Ø§Ù„Ø§Ø³Ù…" }],
                [{ text: "ðŸ“ž Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„" }, { text: "ðŸ“– Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ù† Ø§Ù„Ø¨ÙˆØª" }],
                [{ text: "ðŸŒ Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©" }],
            ],
            resize_keyboard: true,
        },
    };
    bot.sendMessage(chatId, "Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ! Ø§Ø®ØªØ± Ø£Ø­Ø¯ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©:", options);
});

// Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
bot.on('message', async (msg) => {
    const chatId = msg.chat.id;
    const text = msg.text.trim();

    if (text === "ðŸ” Ø§Ù„Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ© Ø£Ùˆ Ø§Ù„Ø§Ø³Ù…") {
        bot.sendMessage(chatId, "ðŸ“ Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ© Ø£Ùˆ Ø§Ù„Ø§Ø³Ù… Ù„Ù„Ø¨Ø­Ø«:");
    } else if (text === "ðŸ“ž Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„") {
        const contactMessage = `
ðŸ“ž **Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„:**
Ù„Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ø¯Ø¹Ù… Ø£Ùˆ Ø§Ù„Ø§Ø³ØªÙØ³Ø§Ø±:
- ðŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ: [mrahel1991@gmail.com]
- ðŸ“± Ø¬ÙˆØ§Ù„: [0598550144]
- ðŸ’¬ ØªÙ„ØºØ±Ø§Ù…: [https://t.me/AhmedGarqoud]
        `;
        bot.sendMessage(chatId, contactMessage, { parse_mode: 'Markdown' });
    } else if (text === "ðŸ“– Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ù† Ø§Ù„Ø¨ÙˆØª") {
        const aboutMessage = `
ðŸ¤– **Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ù† Ø§Ù„Ø¨ÙˆØª:**
Ù‡Ø°Ø§ Ø§Ù„Ø¨ÙˆØª ÙŠØªÙŠØ­ Ù„Ùƒ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…ÙˆØ§Ø·Ù†ÙŠÙ† Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ© Ø£Ùˆ Ø§Ù„Ø§Ø³Ù….
Ù‡Ø¯ÙÙ†Ø§ Ù‡Ùˆ ØªØ³Ù‡ÙŠÙ„ Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.
ðŸ”§ ØªÙ… ØªØ·ÙˆÙŠØ±Ù‡ Ø¨ÙˆØ§Ø³Ø·Ø© [Ø§Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯ Ø§Ø¨Ùˆ ØºØ±Ù‚ÙˆØ¯].
        `;
        bot.sendMessage(chatId, aboutMessage, { parse_mode: 'Markdown' });
    } else if (text === "ðŸŒ Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©") {
        const servicesMessage = `
ðŸŒ **Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©**:
1. ðŸŒ¤ï¸ **Ø£Ø­ÙˆØ§Ù„ Ø§Ù„Ø·Ù‚Ø³**
2. ðŸ’µ **Ø£Ø®Ø¨Ø§Ø± Ø§Ù„Ø¹Ù…Ù„Ø§Øª**
Ø§Ø®ØªØ± Ø§Ù„Ø®Ø¯Ù…Ø© Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯Ù‡Ø§ Ø§Ù„Ø¢Ù†:
        `;
        bot.sendMessage(chatId, servicesMessage);
    } else if (text === "ðŸŒ¤ï¸ Ø£Ø­ÙˆØ§Ù„ Ø§Ù„Ø·Ù‚Ø³") {
        const city = "Gaza,PS"; // Ù…Ø¯ÙŠÙ†Ø© ØºØ²Ø©ØŒ ÙÙ„Ø³Ø·ÙŠÙ†
        try {
            const response = await axios.get(`https://api.openweathermap.org/data/2.5/weather?q=${city}&appid=YOUR_API_KEY`);
            const weather = response.data;
            const weatherMessage = `
ðŸŒ¤ï¸ **Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù‚Ø³ ÙÙŠ ØºØ²Ø©:**
- **Ø§Ù„Ø­Ø±Ø§Ø±Ø©**: ${(weather.main.temp - 273.15).toFixed(2)}Â°C
- **Ø§Ù„ÙˆØµÙ**: ${weather.weather[0].description}
- **Ø§Ù„Ø±Ø·ÙˆØ¨Ø©**: ${weather.main.humidity}%
            `;
            bot.sendMessage(chatId, weatherMessage, { parse_mode: 'Markdown' });
        } catch (error) {
            bot.sendMessage(chatId, "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù‚Ø³. ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯ API Ø§Ù„Ù…ÙØªØ§Ø­.");
        }
    } else if (text === "ðŸ’µ Ø£Ø®Ø¨Ø§Ø± Ø§Ù„Ø¹Ù…Ù„Ø§Øª") {
        try {
            const response = await axios.get(`https://api.exchangerate-api.com/v4/latest/USD`);
            const rates = response.data.rates;
            const currencyMessage = `
ðŸ’µ **Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø¹Ù…Ù„Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù…Ù‚Ø§Ø¨Ù„ Ø§Ù„Ø¯ÙˆÙ„Ø§Ø± Ø§Ù„Ø£Ù…Ø±ÙŠÙƒÙŠ:**
- **1 USD = ${rates.ILS.toFixed(2)} Ø´ÙŠÙƒÙ„**
- **1 USD = ${rates.JOD.toFixed(2)} Ø¯ÙŠÙ†Ø§Ø± Ø£Ø±Ø¯Ù†ÙŠ**
- **1 USD = ${rates.EGP.toFixed(2)} Ø¬Ù†ÙŠÙ‡ Ù…ØµØ±ÙŠ**
            `;
            bot.sendMessage(chatId, currencyMessage, { parse_mode: 'Markdown' });
        } catch (error) {
            bot.sendMessage(chatId, "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø¹Ù…Ù„Ø§Øª.");
        }
    } else {
        bot.sendMessage(chatId, "â“ Ù„Ù… Ø£ÙÙ‡Ù… Ø·Ù„Ø¨Ùƒ. ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø£Ø­Ø¯ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©.");
    }
});

// ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙŠØ±ÙØ±
app.listen(port, () => {
    console.log(`Server is running on port ${port}`);
});
